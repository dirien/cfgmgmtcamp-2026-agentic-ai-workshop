<!DOCTYPE html>
<html lang="en" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }} | {{ site.title }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@primer/css@21/dist/primer.css">
  <style>
    body {
      background-color: var(--bgColor-default, var(--color-canvas-default));
    }
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
    }
    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    }
    .mermaid, pre.mermaid, div.mermaid {
      display: flex;
      justify-content: center;
      background: transparent !important;
      text-align: center;
    }
    pre:has(code.language-mermaid) {
      background: transparent !important;
      border: none !important;
    }
    code.language-mermaid {
      background: transparent !important;
    }
    /* Fix mermaid subgraph/cluster label colors for readability */
    .mermaid .cluster-label,
    .mermaid .cluster-label span,
    .mermaid g.cluster text {
      fill: #1f2328 !important;
      color: #1f2328 !important;
    }
    .theme-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      background: var(--bgColor-muted, var(--color-canvas-subtle));
      border: 1px solid var(--borderColor-default, var(--color-border-default));
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
    }
    .theme-toggle:hover {
      background: var(--bgColor-neutral-muted, var(--color-neutral-muted));
    }
    .header-link {
      color: var(--fgColor-accent, var(--color-accent-fg));
      text-decoration: none;
    }
    .header-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
    <span id="theme-icon"></span>
  </button>
  <article class="markdown-body">
    <header>
      <h1><a href="{{ '/' | relative_url }}" class="header-link">{{ site.title }}</a></h1>
      <hr>
    </header>
    {{ content }}
  </article>
  <script>
    (function() {
      const toggle = document.getElementById('theme-toggle');
      const icon = document.getElementById('theme-icon');
      const html = document.documentElement;

      function getSystemTheme() {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function getStoredTheme() {
        return localStorage.getItem('theme');
      }

      function setTheme(mode) {
        if (mode === 'auto') {
          html.setAttribute('data-color-mode', 'auto');
          localStorage.removeItem('theme');
        } else {
          html.setAttribute('data-color-mode', mode);
          localStorage.setItem('theme', mode);
        }
        updateIcon(mode);
      }

      function updateIcon(mode) {
        if (mode === 'auto') {
          icon.textContent = getSystemTheme() === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        } else {
          icon.textContent = mode === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
      }

      function cycleTheme() {
        const current = html.getAttribute('data-color-mode');
        if (current === 'auto') {
          setTheme(getSystemTheme() === 'dark' ? 'light' : 'dark');
        } else if (current === 'light') {
          setTheme('dark');
        } else {
          setTheme('auto');
        }
      }

      // Initialize
      const stored = getStoredTheme();
      if (stored) {
        setTheme(stored);
      } else {
        setTheme('auto');
      }

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        if (html.getAttribute('data-color-mode') === 'auto') {
          updateIcon('auto');
        }
      });

      toggle.addEventListener('click', cycleTheme);
    })();
  </script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

    function getEffectiveTheme() {
      const colorMode = document.documentElement.getAttribute('data-color-mode');
      if (colorMode === 'auto') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      return colorMode;
    }

    function getMermaidConfig() {
      const isDark = getEffectiveTheme() === 'dark';
      return {
        startOnLoad: false,
        theme: 'base',
        themeVariables: {
          // Background
          background: isDark ? '#0d1117' : '#ffffff',
          // Primary colors for flowcharts
          primaryTextColor: '#1f2328',
          secondaryTextColor: '#1f2328',
          tertiaryTextColor: '#1f2328',
          // Cluster/subgraph styling - always dark text on light fills
          clusterBkg: '#f5f5f5',
          clusterBorder: '#333333',
          // Node styling
          nodeBorder: '#333333',
          mainBkg: '#ffffff',
          // Line/edge colors - must be visible in both modes
          lineColor: isDark ? '#8b949e' : '#333333',
          // Sequence diagram specific
          actorBkg: isDark ? '#21262d' : '#ffffff',
          actorBorder: isDark ? '#8b949e' : '#333333',
          actorTextColor: isDark ? '#c9d1d9' : '#1f2328',
          actorLineColor: isDark ? '#8b949e' : '#333333',
          signalColor: isDark ? '#c9d1d9' : '#1f2328',
          signalTextColor: isDark ? '#c9d1d9' : '#1f2328',
          labelBoxBkgColor: isDark ? '#21262d' : '#ffffff',
          labelBoxBorderColor: isDark ? '#8b949e' : '#333333',
          labelTextColor: isDark ? '#c9d1d9' : '#1f2328',
          loopTextColor: isDark ? '#c9d1d9' : '#1f2328',
          noteBkgColor: isDark ? '#21262d' : '#fff3cd',
          noteTextColor: isDark ? '#c9d1d9' : '#1f2328',
          noteBorderColor: isDark ? '#8b949e' : '#333333',
          // General text
          textColor: '#1f2328'
        }
      };
    }

    mermaid.initialize(getMermaidConfig());
    await mermaid.run({
      querySelector: '.language-mermaid',
    });
  </script>
</body>
</html>
